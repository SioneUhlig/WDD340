<% if (title) { %>
  <h1><%= title %></h1>
<% } %>

<%- messages() %>

<% if (errors) { %>
  <ul class="notice">
    <% errors.array().forEach(error => { %>
      <li><%= error.msg %></li>
    <% }) %>
  </ul>
<% } %>

<div class="respond-inquiry-container">
  <div class="back-link">
    <a href="/inquiry/inbox">‚Üê Back to Inbox</a>
  </div>

  <div class="inquiry-info-section">
    <h2>Customer Inquiry Details</h2>
    
    <div class="inquiry-details">
      <div class="detail-row">
        <strong>Status:</strong>
        <span class="status-badge status-<%= inquiry.inquiry_status %>">
          <%= inquiry.inquiry_status.charAt(0).toUpperCase() + inquiry.inquiry_status.slice(1) %>
        </span>
      </div>
      
      <div class="detail-row">
        <strong>Date Submitted:</strong>
        <%= new Date(inquiry.inquiry_date).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) %>
      </div>
      
      <div class="detail-row">
        <strong>Customer:</strong>
        <%= inquiry.account_firstname %> <%= inquiry.account_lastname %>
      </div>
      
      <div class="detail-row">
        <strong>Email:</strong>
        <a href="mailto:<%= inquiry.account_email %>"><%= inquiry.account_email %></a>
      </div>
      
      <div class="detail-row">
        <strong>Vehicle:</strong>
        <%= inquiry.inv_year %> <%= inquiry.inv_make %> <%= inquiry.inv_model %>
        <a href="/inv/detail/<%= inquiry.vehicle_id %>" target="_blank">(View Vehicle)</a>
      </div>
      
      <div class="detail-row">
        <strong>Price:</strong>
        $<%= new Intl.NumberFormat('en-US').format(inquiry.inv_price) %>
      </div>
    </div>

    <div class="customer-message">
      <h3>Customer's Inquiry</h3>
      <div class="message-box">
        <p><strong>Subject:</strong> <%= inquiry.inquiry_subject %></p>
        <p><strong>Message:</strong></p>
        <p class="message-text"><%= inquiry.inquiry_message %></p>
      </div>
    </div>

    <% if (inquiry.response_message) { %>
      <div class="existing-response">
        <h3>Previous Response</h3>
        <div class="response-box">
          <p><strong>Responded by:</strong> <%= inquiry.responder_firstname %> <%= inquiry.responder_lastname %></p>
          <p><strong>Date:</strong> <%= new Date(inquiry.response_date).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) %></p>
          <p class="response-text"><%= inquiry.response_message %></p>
        </div>
      </div>
    <% } %>
  </div>

  <% if (inquiry.inquiry_status !== 'Closed') { %>
    <div class="response-form-section">
      <h2><%= inquiry.response_message ? 'Send Follow-up Response' : 'Send Response' %></h2>
      
      <form id="responseForm" action="/inquiry/respond" method="post">
        <input type="hidden" name="inquiry_id" value="<%= inquiry.inquiry_id %>">
        
        <label for="response_message">Response Message:</label>
        <textarea id="response_message" 
                  name="response_message" 
                  required 
                  minlength="10"
                  maxlength="2000"
                  rows="10"
                  placeholder="Type your response to the customer here..."><%= locals.response_message || '' %></textarea>
        
        <div class="character-count">
          <span id="charCount">0</span> / 2000 characters
        </div>
        
        <div class="form-actions">
          <button type="submit" class="submit-btn">Send Response</button>
          <a href="/inquiry/inbox" class="cancel-btn">Cancel</a>
        </div>
      </form>
    </div>
  <% } else { %>
    <div class="closed-message">
      <p><strong>This inquiry has been closed.</strong></p>
      <p>To respond, please change the status to "Pending" or "Resolved" from the inquiry management section below.</p>
    </div>
  <% } %>

  <div class="inquiry-management">
    <h3>Inquiry Management</h3>
    
    <form action="/inquiry/update-status" method="post" class="status-form">
      <input type="hidden" name="inquiry_id" value="<%= inquiry.inquiry_id %>">
      <label for="status">Update Status:</label>
      <select name="status" id="status" class="status-select">
        <option value="Pending" <%= inquiry.inquiry_status === 'Pending' ? 'selected' : '' %>>Pending</option>
        <option value="In Progress" <%= inquiry.inquiry_status === 'In Progress' ? 'selected' : '' %>>In Progress</option>
        <option value="Resolved" <%= inquiry.inquiry_status === 'Resolved' ? 'selected' : '' %>>Resolved</option>
        <option value="Closed" <%= inquiry.inquiry_status === 'Closed' ? 'selected' : '' %>>Closed</option>
      </select>
      <button type="submit" class="update-btn">Update Status</button>
    </form>

    <form action="/inquiry/delete" method="post" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this inquiry? This action cannot be undone.');">
      <input type="hidden" name="inquiry_id" value="<%= inquiry.inquiry_id %>">
      <button type="submit" class="delete-btn">Delete Inquiry</button>
    </form>
  </div>
</div>

<script>
// Character counter for response textarea
const responseTextarea = document.getElementById('response_message');
const charCount = document.getElementById('charCount');

function updateCharCount() {
  if (responseTextarea) {
    charCount.textContent = responseTextarea.value.length;
    if (responseTextarea.value.length > 1900) {
      charCount.style.color = '#f44336';
    } else {
      charCount.style.color = '#666';
    }
  }
}

if (responseTextarea) {
  responseTextarea.addEventListener('input', updateCharCount);
  // Initialize on page load
  updateCharCount();
}
</script>